import pgzrun
import random

#Initialize
WIDTH,HEIGHT = 768,432
TIME = 0
letters = []
for i in range(26):
    letters.append(chr(97+i))
HP_BAR = []
for i in range(21):
    HP_BAR.append('hp_bar\\'+str(i))
idlerset,ground = [],[]
spdx,fq = 5,30
words = [] 
flag = False
##Import images
#Character
for i in range(12):
    idlerset.append('idle\\idler\\idler'+str(i))
#Floor
for i in range(50):
    ground.append(Actor('tileset\\ground'))

##Setup Character
#PLAYER
PLAYER = Actor('idle\idler\idler0')
PLAYER.jumph = 0
PLAYER.frame = 0
PLAYER.state = 'IDLE'
PLAYER.direction = 'RIGHT'
PLAYER.hp = 20
PLAYER.hpBar = Actor(HP_BAR[20])
#BOSS
BOSS = Actor("soul_reaper\\idle")
BOSS.hp = 20
BOSS.hpBar = Actor(HP_BAR[20])
Bossattack = Actor("transparent")
Heroattack= Actor("transparent")
def initializeVariable():
    global TIME,PLAYER,BOSS,spdx,fq,words,flag
    spdx,fq = 5,30
    words = [] 
    flag = False
    PLAYER = Actor('idle\idler\idler0')
    PLAYER.jumph = 0
    PLAYER.frame = 0
    PLAYER.state = 'IDLE'
    PLAYER.direction = 'RIGHT'
    PLAYER.hp = 20
    PLAYER.hpBar = Actor(HP_BAR[20])
    BOSS = Actor("soul_reaper\\idle")
    BOSS.hp = 20
    BOSS.hpBar = Actor(HP_BAR[20])
def initializeMap():
    #Player and boss and Hp
    PLAYER.bottomleft = PLAYER.width*3,HEIGHT-ground[0].height
    BOSS.bottomright = WIDTH,HEIGHT
    PLAYER.hpBar.center = (100,320)
    BOSS.hpBar.center = (590,130)
    Bossattack.center=(-310,650)
    Heroattack.center=(420,130)
    #Floor
    for i in range(50):
        ground[i].topright = (i+1)*(ground[i].width-5),HEIGHT - ground[i].height + 2
    
def restartStage():
    initializeVariable()
    initializeMap()

##Character Status change
def PLAYER_idle():
    PLAYER.frame += 0.25
    PLAYER.image = idlerset[int(PLAYER.frame)%12]

def PLAYER_injured():
    global PLAYER
    PLAYER.image="player_injured"
    PLAYER.hp -= 5
    if(PLAYER.hp < 0):
        PLAYER.hp = 0
        PLAYER.image = 'soul_reaper\\injured'
    PLAYER.hpBar.image = HP_BAR[int(PLAYER.hp)]
    clock.schedule_unique(PLAYER_idle,1.0)

def BOSS_idle():
    BOSS.image="soul_reaper\\idle"

def BOSS_injured():
    global BOSS
    BOSS.image="soul_reaper\\injured"
    BOSS.hp -= 0.5
    if(BOSS.hp < 0):
        BOSS.hp = 0
    BOSS.hpBar.image = HP_BAR[int(BOSS.hp)]
    clock.schedule_unique(BOSS_idle,1.0)



## Interaction
def on_key_down(key):
    global flag
    flag=key.name.lower()

def playerLose():
    if(PLAYER.hp <= 0):
        return True
    return False

def playerWin():
    if(BOSS.hp <= 0):
        return True
    return False

def nextStage():
    pass

def drawStage3():
    for i in range(4):
        screen.blit(('background\\plx-'+str(i+1)),(0,0))
    for i in ground:
        i.draw()
    PLAYER.draw()
    PLAYER.hpBar.draw()
    BOSS.draw()
    BOSS.hpBar.draw()
    Bossattack.draw()
    Heroattack.draw()

def draw():
    screen.clear()
    drawStage3()
    for i in words:
        i.draw()
def bossattack():
    Bossattack.image=("bossattack")
    clock.schedule_unique(bossattacknormal,0.3)
def bossattacknormal():
    Bossattack.image=("transparent")

def heroattack():
    Heroattack.image=("heroattack")
    clock.schedule_unique(heroattacknormal,0.3)
def heroattacknormal():
    Heroattack.image=("transparent")
def update():
    global PLAYER,flag,key_pressed,TIME,spdx
    TIME += 1
    if(PLAYER.state == 'DEAD'):
        return
    if(playerWin()):
        clock.schedule(restartStage,0.25)
        return
        #return nextStage()
    if(playerLose()):
        PLAYER.state = 'DEAD'
        PLAYER.image = "soul_reaper\\injured"
        clock.schedule(restartStage,0.25)
        return
    if BOSS.hp >= 13:
        frq = BOSS.hp / 20 * 30
        spdx = 20 / BOSS.hp * 5
    elif BOSS.hp <13:
        spdx = 8
    elif BOSS.hp <5:
        spdx = 20/ BOSS.hp +8
    if TIME % fq == 0:
        x=random.choice(letters)
        y=str.upper(x)
        t=Actor('alphabets\\'+x)
        t.name = x
        words.append(t)
    for i in words:
        i.left += spdx
        if i.left>=WIDTH:
           words.remove(i)
           PLAYER_injured()
           bossattack()
    if(words != [] and words[0].name == flag):
        words.remove(words[0])
        BOSS_injured()
        heroattack()
        flag = False
    else:
        if flag:
            PLAYER_injured()
            bossattack()
            flag= False

restartStage()
sounds.music.play(loops=10)
sounds.music.set_volume(0.2)
pgzrun.go()
