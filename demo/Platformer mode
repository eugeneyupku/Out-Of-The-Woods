import pgzrun
import types
##Initialize
WIDTH,HEIGHT = 768,432
TIME = 0
runlset,runrset,idlelset,idlerset = [],[],[],[] #List of actions' frames
bg1,bg2 = [],[] #Background
ground,layer1 = [],[] #Ground and layer1
trap = []
spdx = 3 #Speed of moves

##Import images
#Character
for i in range(8):
    runrset.append('run\\runr\\right'+str(i))
    runlset.append('run\\runl\\left'+str(i))
for i in range(12):
    idlerset.append('idle\\idler\\idler'+str(i))
    idlelset.append('idle\\idlel\\idlel'+str(i))
#Background
for i in range(5):
    bg1.append(Actor("background\\plx-" + str(i+1)))
    bg2.append(Actor("background\\plx-" + str(i+1)))
#Floor
for i in range(50):
    ground.append(Actor('tileset\\ground'))
for i in range(10):
    layer1.append(Actor('tileset\\ground'))
#Trap
for i in range(2):
    trap.append(Actor('trap'))        

##Setup Character
PLAYER = Actor('idle\idler\idler0')
PLAYER.jumph = 0
PLAYER.frame = 0
PLAYER.state = 'FALL'
PLAYER.direction = 'RIGHT'

##Camera
rightLimit,leftLimit = 50*81-WIDTH/2,WIDTH/2 
rightBorder,leftBorder = 50*81-PLAYER.width,PLAYER.width
camCenter = leftBorder
##Initialize variables
def initializeVariable():
    global PLAYER,rightlimit,leftLimit,rightBorder,leftBorder,camCenter
    PLAYER.jumph = 0
    PLAYER.frame = 0
    PLAYER.state = 'FALL'
    PLAYER.direction = 'RIGHT'
    rightLimit,leftLimit = 50*81-WIDTH/2,WIDTH/2 
    rightBorder,leftBorder = 50*81-PLAYER.width,PLAYER.width
    camCenter = leftBorder
##Setup map
def initializeMap():
    #Player
    PLAYER.topleft = 0,0
    #Background
    for i in range(5):
        bg1[i].topright = WIDTH*0.5,0
        bg2[i].topleft = WIDTH*0.5,0
    #Trap
    trap[1].bottomleft = 0,HEIGHT-1
    trap[0].bottomleft = ground[0].width,HEIGHT-1
    #Floor
    for i in range(50):
        ground[i].bottomright = (i+1)*(ground[i].width-5),HEIGHT
    for i in range(10):
        layer1[i].bottomright = 5*(i+1)*(ground[i].width),HEIGHT - PLAYER.height-ground[i].height+2

##Combine Lists
floor = ground + layer1
tiles = trap + floor
bg = bg1 + bg2
everything = tiles + bg

##Actor Moves
#Infinite Moves
def moveLeft(act,mode=0): ##Mode 0: Infinite Move; Mode 1: Bordered Move
    if(mode == 1 and act.left <= 0):
        return
    act.left -= spdx
    if(mode == 0 and act.right < 0):
        act.left = WIDTH-spdx

def moveRight(act,mode=0):
    if(mode == 1 and act.right >= WIDTH):
        return
    act.left += spdx
    if(mode == 0 and act.left > WIDTH):
        act.right = spdx

## Move in group
#Background
def bgLeft():
    for i in bg:
        moveLeft(i)
def bgRight():
    for i in bg:
        moveRight(i)
#Floor
def tilesLeft():
    for i in tiles:
        i.left -= spdx
def tilesRight():
    for i in tiles:
        i.left += spdx

#Screen
def screenLeft():
    global camCenter
    camCenter += spdx
    if(camCenter > rightBorder):
        camCenter = rightBorder
    if(rightLimit <= camCenter):
        PLAYER.moveRight(1)
    elif(camCenter <= leftLimit):
        PLAYER.moveRight(1)
    else:
        bgLeft()
        tilesLeft()
def screenRight():
    global camCenter
    camCenter -= spdx
    if(camCenter < leftBorder):
        camCenter = leftBorder
    if(camCenter <= leftLimit):
        PLAYER.moveLeft(1)
    elif(rightLimit <= camCenter):
        PLAYER.moveLeft(1)
    else:
        bgRight()
        tilesRight()

#Interaction
def collideFloor():
    for i in floor:
        if(PLAYER.colliderect(i) and i.top-4*spdx<= PLAYER.bottom <= i.top+4*spdx):
            return True
    return False
def playerLose():
    global PLAYER
    for i in trap:
        if(PLAYER.colliderect(i)):
            i.top -= 30
            return True
    return False

##Set Attribute
PLAYER.__setattr__('moveRight',types.MethodType(moveRight,PLAYER))
PLAYER.__setattr__('moveLeft',types.MethodType(moveLeft,PLAYER))

##Restart Stage
def restartStage():
    initializeVariable()
    initializeMap()

def drawStage1():
    for i in bg:
        i.draw()
    for i in trap:
        i.draw()    
    for i in tiles:
        i.draw()
##Draw & Update
def draw():
    drawStage1()
    PLAYER.draw()

def update():
    global PLAYER
    if(PLAYER.state == 'DEAD'):
        return
    ##Interactions
    if(playerLose()):
        PLAYER.state = 'DEAD'
        clock.schedule(restartStage,0.25)
        return
    #On Floor
    PLAYER.floor = collideFloor()
    ##JUMP
    if(keyboard.up and PLAYER.state != 'FALL' and PLAYER.state != 'JUMP'):
        PLAYER.jumph = 0
        PLAYER.state = 'JUMP'
    if(PLAYER.state == 'JUMP'):
        if(PLAYER.direction == 'RIGHT'):
            PLAYER.image = 'jump\\jumpr'
        elif (PLAYER.direction == 'LEFT'):
            PLAYER.image = 'jump\\jumpl'
        PLAYER.top -= spdx*1.5
        PLAYER.jumph += spdx*1.5
        if(keyboard.right):
            PLAYER.direction = 'RIGHT'
            screenLeft()
        elif(keyboard.left):
            PLAYER.direction = 'LEFT'
            screenRight()
        if(PLAYER.jumph >= PLAYER.height + 2*ground[0].height):
            PLAYER.state = 'FALL'
        return
    if not PLAYER.floor:
        PLAYER.state = 'FALL'
    if(PLAYER.state == 'FALL'):
        if(PLAYER.direction == 'RIGHT'):
            PLAYER.image = 'landing\\landingr'
        elif (PLAYER.direction == 'LEFT'):
            PLAYER.image = 'landing\\landingl'
        PLAYER.top += spdx*1.5
        PLAYER.jumph -= spdx*1.5
        if(keyboard.right):
            PLAYER.direction = 'RIGHT'
            screenLeft()
        elif(keyboard.left):
            PLAYER.direction = 'LEFT'
            screenRight()
        if collideFloor():
            PLAYER.state = 'IDLE'
        return
    ##MOVE RIGHT    
    if(keyboard.right):
        if(PLAYER.state != 'RUN'):
            PLAYER.frame = 0
        PLAYER.state,PLAYER.direction = 'RUN','RIGHT'
        PLAYER.frame += 0.25
        PLAYER.image = runrset[int(PLAYER.frame)%8]
        screenLeft()
        return
    ##MOVE LEFT
    elif(keyboard.left): 
        if(PLAYER.state != 'RUN'):
            PLAYER.frame = 0
        PLAYER.state,PLAYER.direction = 'RUN','LEFT'
        PLAYER.frame += 0.25
        PLAYER.image = runlset[int(PLAYER.frame)%8]
        screenRight()
        return
    if(PLAYER.state != 'IDLE'):
        PLAYER.frame = 0
    PLAYER.state = 'IDLE'
    ##IDLE
    if(PLAYER.state == 'IDLE' and PLAYER.direction == 'LEFT'): 
        PLAYER.frame += 0.25
        PLAYER.image = idlelset[int(PLAYER.frame)%12]
    elif(PLAYER.state == 'IDLE' and PLAYER.direction == 'RIGHT'):
        PLAYER.frame += 0.25
        PLAYER.image = idlerset[int(PLAYER.frame)%12]
initializeMap()
pgzrun.go()
